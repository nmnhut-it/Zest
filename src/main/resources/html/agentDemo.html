<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Framework Demo</title>
    <!-- Load scripts from resources using relative paths -->
    <script>
        // Check if we're running in JCEF with resource support
        if (window.location.protocol === 'jcef:') {
            console.log('Running in JCEF with resource support');
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4CAF50;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
        }
        
        .demo-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .demo-section h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .output {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .status.success {
            background: #4CAF50;
            color: white;
        }
        
        .status.error {
            background: #f44336;
            color: white;
        }
        
        .status.warning {
            background: #FF9800;
            color: white;
        }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .agent-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.3s;
        }
        
        .agent-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }
        
        .agent-card h3 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        .agent-card p {
            color: #aaa;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .code-block {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .code-block pre {
            margin: 0;
            color: #d4d4d4;
        }
        
        .workflow-visualizer {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .workflow-step-icon {
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-weight: bold;
        }
        
        .workflow-step-content {
            flex: 1;
        }
        
        .workflow-step-title {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .workflow-step-description {
            color: #888;
            font-size: 0.9em;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Agent Framework Demo</h1>
        <p class="subtitle">Powered by Google Agent-to-Agent SDK</p>
        
        <div class="demo-section" style="background: #2a4a2a; border-color: #4CAF50;">
            <h2>Welcome to the Agent Framework!</h2>
            <p>This demo is loaded from IntelliJ resources using the custom scheme: <code>jcef://resource/html/agentDemo.html</code></p>
            <p>You can also access this demo by:</p>
            <ul style="margin-left: 20px;">
                <li>Using the "Show Agent Framework" action in IntelliJ</li>
                <li>Calling <code>browserManager.loadAgentDemo()</code> in your code</li>
                <li>Navigating to <code>jcef://resource/html/agentDemo.html</code> in the browser</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <h2>Quick Start</h2>
            <div class="button-group">
                <button onclick="initializeFramework()">Initialize Framework</button>
                <button onclick="createDefaultTeam()">Create Default Team</button>
                <button onclick="showAgentStatus()">Show Agent Status</button>
                <button onclick="runSimpleDemo()">Run Simple Demo</button>
            </div>
            <div id="quickstart-output" class="output"></div>
        </div>
        
        <div class="demo-section">
            <h2>Available Agent Roles</h2>
            <div class="agent-grid" id="agent-roles-grid"></div>
        </div>
        
        <div class="demo-section">
            <h2>Complex Workflows</h2>
            <div class="button-group">
                <button onclick="runFullStackWorkflow()">Full Stack Development</button>
                <button onclick="runCodeReviewWorkflow()">Code Review Pipeline</button>
                <button onclick="runBugFixWorkflow()">Bug Fix Workflow</button>
                <button onclick="runAPIDesignWorkflow()">API Design Workflow</button>
            </div>
            <div class="workflow-visualizer" id="workflow-visualizer" style="display: none;"></div>
            <div id="workflow-output" class="output"></div>
        </div>
        
        <div class="demo-section">
            <h2>Google Agent Integration</h2>
            <div class="button-group">
                <button onclick="connectToGoogle()">Connect to Google Agents</button>
                <button onclick="collaborateWithGoogle()">Collaborate with Google Agent</button>
                <button onclick="importGoogleWorkflow()">Import Google Workflow</button>
            </div>
            <div id="google-output" class="output"></div>
        </div>
        
        <div class="demo-section">
            <h2>LLM Provider Integration</h2>
            <div class="button-group">
                <button onclick="testLLMProvider()">Test LLM Connection</button>
                <button onclick="listAvailableModels()">List Models</button>
                <button onclick="generateWithLLM()">Generate Code</button>
                <button onclick="reviewWithLLM()">Review Code</button>
            </div>
            <div id="llm-output" class="output"></div>
        </div>
        
        <div class="demo-section">
            <h2>Visual Workflow Builder</h2>
            <p>Create complex agent workflows with a drag-and-drop interface!</p>
            <div class="button-group">
                <button onclick="openWorkflowBuilder()">üîß Open Workflow Builder</button>
                <button onclick="loadExampleWorkflow()">üìÅ Load Example Workflow</button>
                <button onclick="showWorkflowTutorial()">üìñ Tutorial</button>
            </div>
            <div id="workflow-builder-output" class="output"></div>
        </div>
        
        <div class="demo-section">
            <h2>Live Code Generation</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Describe what you want to build:</label>
                <textarea id="code-description" style="width: 100%; height: 80px; background: #0a0a0a; color: #e0e0e0; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: inherit;" placeholder="e.g., Create a React component for a user profile card with avatar, name, and social links"></textarea>
            </div>
            <div class="button-group">
                <button onclick="generateCode('javascript')">Generate JavaScript</button>
                <button onclick="generateCode('python')">Generate Python</button>
                <button onclick="generateCode('java')">Generate Java</button>
                <button onclick="generateWithReview()">Generate + Review</button>
            </div>
            <div id="generation-output" class="output"></div>
        </div>
    </div>

    <script>
        // Global variables
        let frameworkInitialized = false;
        let defaultTeam = null;
        
        // Utility function to log output
        function log(elementId, message, status = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = status === 'error' ? 'error' : status === 'success' ? 'success' : 'warning';
            const statusBadge = status !== 'info' ? `<span class="status ${statusClass}">${status.toUpperCase()}</span>` : '';
            
            output.innerHTML += `[${timestamp}] ${statusBadge}${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        // Initialize the framework
        async function initializeFramework() {
            if (frameworkInitialized) {
                log('quickstart-output', 'Framework already initialized', 'warning');
                return;
            }
            
            try {
                log('quickstart-output', 'Initializing Agent Framework...');
                
                // Wait for framework to be loaded
                if (!window.AgentFramework) {
                    log('quickstart-output', 'Waiting for Agent Framework to load...');
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (window.AgentFramework) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Display available roles
                displayAgentRoles();
                
                frameworkInitialized = true;
                log('quickstart-output', 'Agent Framework initialized successfully!', 'success');
                
                // Initialize UI
                if (window.AgentUI) {
                    window.AgentUI.initialize('agent-ui-container');
                    log('quickstart-output', 'Agent UI initialized', 'success');
                }
                
            } catch (error) {
                log('quickstart-output', `Initialization failed: ${error.message}`, 'error');
            }
        }
        
        // Display available agent roles
        function displayAgentRoles() {
            const grid = document.getElementById('agent-roles-grid');
            grid.innerHTML = '';
            
            for (const [key, role] of Object.entries(window.AgentFramework.AgentRoles)) {
                const card = document.createElement('div');
                card.className = 'agent-card';
                card.innerHTML = `
                    <h3>${role.name}</h3>
                    <p>${role.description}</p>
                    <p style="font-size: 0.8em; color: #666;">Capabilities: ${role.capabilities.join(', ')}</p>
                `;
                grid.appendChild(card);
            }
        }
        
        // Create default team
        async function createDefaultTeam() {
            if (!frameworkInitialized) {
                await initializeFramework();
            }
            
            try {
                log('quickstart-output', 'Creating default development team...');
                
                defaultTeam = await window.AgentFramework.createTeam({
                    name: 'Default Development Team',
                    agents: [
                        { role: 'CODE_GENERATOR' },
                        { role: 'CODE_REVIEWER' },
                        { role: 'TESTING' },
                        { role: 'DOCUMENTATION' },
                        { role: 'SECURITY' }
                    ]
                });
                
                log('quickstart-output', `Team created with ${defaultTeam.agents.length} agents`, 'success');
                
                // List team members
                defaultTeam.agents.forEach(agent => {
                    log('quickstart-output', `  - ${agent.role.name} (${agent.id})`);
                });
                
            } catch (error) {
                log('quickstart-output', `Failed to create team: ${error.message}`, 'error');
            }
        }
        
        // Show agent status
        async function showAgentStatus() {
            if (!frameworkInitialized) {
                log('quickstart-output', 'Framework not initialized', 'warning');
                return;
            }
            
            try {
                const status = window.AgentFramework.AgentManager.getStatus();
                
                log('quickstart-output', '\n=== Agent Status ===');
                log('quickstart-output', `Total Agents: ${status.agents.length}`);
                log('quickstart-output', `Total Tasks: ${status.totalTasks}`);
                log('quickstart-output', `Active Tasks: ${status.activeTasks}`);
                
                status.agents.forEach(agent => {
                    log('quickstart-output', `\n${agent.role} (${agent.id})`);
                    log('quickstart-output', `  State: ${agent.state}`);
                    log('quickstart-output', `  Completed: ${agent.stats.tasksCompleted}`);
                    log('quickstart-output', `  Failed: ${agent.stats.tasksFailed}`);
                    log('quickstart-output', `  Queue: ${agent.queueLength}`);
                });
                
            } catch (error) {
                log('quickstart-output', `Failed to get status: ${error.message}`, 'error');
            }
        }
        
        // Run simple demo
        async function runSimpleDemo() {
            if (!defaultTeam) {
                await createDefaultTeam();
            }
            
            try {
                log('quickstart-output', '\n=== Running Simple Demo ===');
                
                // Find code generator
                const codeGenerator = defaultTeam.agents.find(a => a.role.id === 'code_generator');
                
                if (!codeGenerator) {
                    throw new Error('Code generator not found in team');
                }
                
                // Generate simple code
                const taskId = codeGenerator.queueTask({
                    type: 'generate',
                    data: {
                        type: 'function',
                        language: 'javascript',
                        specification: {
                            name: 'calculateSum',
                            description: 'Calculate the sum of an array of numbers',
                            parameters: ['numbers: array'],
                            returns: 'number'
                        }
                    },
                    callback: (error, result) => {
                        if (error) {
                            log('quickstart-output', `Generation failed: ${error.message}`, 'error');
                        } else {
                            log('quickstart-output', 'Code generated successfully:', 'success');
                            log('quickstart-output', result.code);
                        }
                    }
                });
                
                log('quickstart-output', `Task queued with ID: ${taskId}`);
                
            } catch (error) {
                log('quickstart-output', `Demo failed: ${error.message}`, 'error');
            }
        }
        
        // Run full stack workflow
        async function runFullStackWorkflow() {
            if (!defaultTeam) {
                await createDefaultTeam();
            }
            
            try {
                log('workflow-output', '\n=== Full Stack Development Workflow ===');
                visualizeWorkflow([
                    { icon: '1', title: 'API Design', description: 'Design RESTful API endpoints' },
                    { icon: '2', title: 'Backend Development', description: 'Implement server-side logic' },
                    { icon: '3', title: 'Frontend Development', description: 'Create user interface' },
                    { icon: '4', title: 'Testing', description: 'Write and run tests' },
                    { icon: '5', title: 'Documentation', description: 'Generate API docs' }
                ]);
                
                // Register workflow
                window.AgentFramework.AgentManager.registerWorkflow('fullstack-workflow', {
                    name: 'Full Stack Development',
                    steps: [
                        {
                            name: 'Design API',
                            requiredCapability: 'design_api',
                            type: 'design_api',
                            data: {
                                resource: 'users',
                                operations: ['create', 'read', 'update', 'delete'],
                                authentication: 'JWT'
                            }
                        },
                        {
                            name: 'Generate Backend',
                            requiredCapability: 'generate',
                            type: 'generate',
                            data: {
                                type: 'express-api',
                                language: 'javascript',
                                specification: {
                                    framework: 'express',
                                    database: 'mongodb'
                                }
                            }
                        },
                        {
                            name: 'Generate Frontend',
                            requiredCapability: 'generate',
                            type: 'generate',
                            data: {
                                type: 'react-app',
                                language: 'javascript',
                                specification: {
                                    framework: 'react',
                                    styling: 'tailwind'
                                }
                            }
                        },
                        {
                            name: 'Create Tests',
                            requiredCapability: 'create_tests',
                            type: 'create_tests',
                            data: {
                                language: 'javascript',
                                framework: 'jest',
                                coverage: 80
                            }
                        }
                    ]
                });
                
                // Execute workflow
                const coordinator = defaultTeam.coordinator;
                coordinator.queueTask({
                    type: 'orchestrate',
                    data: {
                        workflow: window.AgentFramework.AgentManager.workflows.get('fullstack-workflow'),
                        data: {}
                    },
                    callback: (error, result) => {
                        if (error) {
                            log('workflow-output', `Workflow failed: ${error.message}`, 'error');
                        } else {
                            log('workflow-output', 'Workflow completed successfully!', 'success');
                            log('workflow-output', `Summary: ${JSON.stringify(result.summary, null, 2)}`);
                        }
                    }
                });
                
                log('workflow-output', 'Full stack workflow started...');
                
            } catch (error) {
                log('workflow-output', `Workflow failed: ${error.message}`, 'error');
            }
        }
        
        // Visualize workflow
        function visualizeWorkflow(steps) {
            const visualizer = document.getElementById('workflow-visualizer');
            visualizer.style.display = 'block';
            visualizer.innerHTML = '<h3 style="color: #4CAF50; margin-top: 0;">Workflow Steps:</h3>';
            
            steps.forEach(step => {
                visualizer.innerHTML += `
                    <div class="workflow-step">
                        <div class="workflow-step-icon">${step.icon}</div>
                        <div class="workflow-step-content">
                            <div class="workflow-step-title">${step.title}</div>
                            <div class="workflow-step-description">${step.description}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Generate code based on description
        async function generateCode(language) {
            if (!defaultTeam) {
                await createDefaultTeam();
            }
            
            const description = document.getElementById('code-description').value;
            if (!description) {
                log('generation-output', 'Please enter a description', 'warning');
                return;
            }
            
            try {
                log('generation-output', `\n=== Generating ${language} code ===`);
                log('generation-output', `Description: ${description}`);
                
                const codeGenerator = defaultTeam.agents.find(a => a.role.id === 'code_generator');
                
                codeGenerator.queueTask({
                    type: 'generate',
                    data: {
                        type: 'custom',
                        language: language,
                        specification: {
                            description: description
                        }
                    },
                    callback: (error, result) => {
                        if (error) {
                            log('generation-output', `Generation failed: ${error.message}`, 'error');
                        } else {
                            log('generation-output', 'Code generated successfully!', 'success');
                            log('generation-output', '```' + language);
                            log('generation-output', result.code);
                            log('generation-output', '```');
                            
                            // Send to IntelliJ
                            if (window.intellijBridge) {
                                window.intellijBridge.callIDE('insertCode', {
                                    code: result.code,
                                    language: language
                                });
                                log('generation-output', 'Code sent to IntelliJ', 'success');
                            }
                        }
                    }
                });
                
            } catch (error) {
                log('generation-output', `Generation failed: ${error.message}`, 'error');
            }
        }
        
        // Generate with review
        async function generateWithReview() {
            const language = 'javascript';
            await generateCode(language);
            
            // Wait a bit for generation to complete
            setTimeout(() => {
                const codeReviewer = defaultTeam.agents.find(a => a.role.id === 'code_reviewer');
                
                log('generation-output', '\n=== Running Code Review ===');
                
                codeReviewer.queueTask({
                    type: 'review',
                    data: {
                        code: '// Generated code would be here',
                        language: language,
                        context: {}
                    },
                    callback: (error, result) => {
                        if (error) {
                            log('generation-output', `Review failed: ${error.message}`, 'error');
                        } else {
                            log('generation-output', `Review completed! Score: ${result.score}/100`, result.passed ? 'success' : 'warning');
                            
                            if (result.issues.length > 0) {
                                log('generation-output', '\nIssues found:');
                                result.issues.forEach(issue => {
                                    log('generation-output', `  - [${issue.severity}] ${issue.message}`);
                                });
                            }
                            
                            if (result.suggestions.length > 0) {
                                log('generation-output', '\nSuggestions:');
                                result.suggestions.forEach(suggestion => {
                                    log('generation-output', `  - ${suggestion}`);
                                });
                            }
                        }
                    }
                });
            }, 2000);
        }
        
        // Connect to Google Agents
        async function connectToGoogle() {
            try {
                log('google-output', 'Connecting to Google Agent service...');
                
                // Initialize Google integration
                await window.GoogleAgentIntegration.initialize({
                    apiKey: 'YOUR_GOOGLE_API_KEY', // Replace with actual key
                    projectId: 'YOUR_PROJECT_ID'   // Replace with actual project ID
                });
                
                log('google-output', 'Connected to Google Agent service!', 'success');
                log('google-output', `Session ID: ${window.GoogleAgentIntegration.sessionId}`);
                
            } catch (error) {
                log('google-output', `Connection failed: ${error.message}`, 'error');
                log('google-output', 'Note: Please configure your Google API credentials');
            }
        }
        
        // Other workflow functions
        async function runCodeReviewWorkflow() {
            log('workflow-output', 'Code Review workflow not yet implemented', 'warning');
        }
        
        async function runBugFixWorkflow() {
            log('workflow-output', 'Bug Fix workflow not yet implemented', 'warning');
        }
        
        async function runAPIDesignWorkflow() {
            log('workflow-output', 'API Design workflow not yet implemented', 'warning');
        }
        
        async function collaborateWithGoogle() {
            log('google-output', 'Google collaboration not yet implemented', 'warning');
        }
        
        async function importGoogleWorkflow() {
            log('google-output', 'Google workflow import not yet implemented', 'warning');
        }
        
        // LLM Provider functions
        async function testLLMProvider() {
            try {
                log('llm-output', 'Testing LLM Provider connection...');
                
                if (!window.LLMProvider) {
                    throw new Error('LLM Provider not loaded');
                }
                
                // Test with a simple prompt
                const response = await window.LLMProvider.callAPI('Hello! Can you confirm the connection is working?', {
                    maxTokens: 50
                });
                
                log('llm-output', 'Connection successful!', 'success');
                log('llm-output', `Response: ${response}`);
                
            } catch (error) {
                log('llm-output', `Connection test failed: ${error.message}`, 'error');
                log('llm-output', 'Make sure you are logged into OpenWebUI');
            }
        }
        
        async function listAvailableModels() {
            try {
                log('llm-output', 'Fetching available models...');
                
                const models = await window.LLMProvider.getAvailableModels();
                
                if (models.length > 0) {
                    log('llm-output', `Found ${models.length} models:`, 'success');
                    models.forEach(model => {
                        log('llm-output', `  - ${model.id || model.name || model}`);
                    });
                } else {
                    log('llm-output', 'No models found', 'warning');
                }
                
            } catch (error) {
                log('llm-output', `Failed to fetch models: ${error.message}`, 'error');
            }
        }
        
        async function generateWithLLM() {
            const description = document.getElementById('code-description').value;
            if (!description) {
                log('llm-output', 'Please enter a description in the Live Code Generation section', 'warning');
                return;
            }
            
            try {
                log('llm-output', '\n=== Generating Code with LLM ===');
                log('llm-output', `Description: ${description}`);
                
                const code = await window.LLMProvider.generateCode(description, 'javascript');
                
                log('llm-output', 'Code generated successfully!', 'success');
                log('llm-output', '```javascript');
                log('llm-output', code);
                log('llm-output', '```');
                
                // Send to IntelliJ
                if (window.intellijBridge) {
                    await window.intellijBridge.callIDE('insertCode', {
                        code: code,
                        language: 'javascript'
                    });
                    log('llm-output', 'Code sent to IntelliJ', 'success');
                }
                
            } catch (error) {
                log('llm-output', `Code generation failed: ${error.message}`, 'error');
            }
        }
        
        async function reviewWithLLM() {
            try {
                log('llm-output', '\n=== Code Review with LLM ===');
                
                // Sample code for review
                const sampleCode = `
function calculateTotal(items) {
    var total = 0;
    for (var i = 0; i < items.length; i++) {
        total = total + items[i].price;
    }
    return total;
}`;
                
                log('llm-output', 'Reviewing sample code...');
                log('llm-output', '```javascript' + sampleCode + '\n```');
                
                const review = await window.LLMProvider.reviewCode(sampleCode, 'javascript');
                
                log('llm-output', 'Review completed!', 'success');
                log('llm-output', review);
                
            } catch (error) {
                log('llm-output', `Code review failed: ${error.message}`, 'error');
            }
        }
        
        // Workflow Builder functions
        function openWorkflowBuilder() {
            // Create a new window for the workflow builder
            const builderWindow = window.open('', 'WorkflowBuilder', 'width=1200,height=800');
            
            // Initialize the workflow builder in the new window
            builderWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Agent Workflow Builder</title>
                </head>
                <body>
                    <div id="workflow-builder"></div>
                    <script>
                        // Copy necessary objects from parent window
                        window.AgentFramework = window.opener.AgentFramework;
                        window.WorkflowEngine = window.opener.WorkflowEngine;
                        window.WorkflowBuilder = window.opener.WorkflowBuilder;
                        window.intellijBridge = window.opener.intellijBridge;
                        window.LLMProvider = window.opener.LLMProvider;
                        
                        // Initialize the builder
                        window.onload = function() {
                            WorkflowBuilder.initialize('workflow-builder');
                            
                            // Load example workflow if available
                            if (window.opener.exampleWorkflow) {
                                setTimeout(() => {
                                    WorkflowBuilder.loadWorkflow(window.opener.exampleWorkflow.toJSON());
                                }, 500);
                            }
                        };
                    </script>
                </body>
                </html>
            `);
            
            log('workflow-builder-output', 'Workflow Builder opened in new window', 'success');
        }
        
        async function loadExampleWorkflow() {
            if (!frameworkInitialized) {
                await initializeFramework();
            }
            
            try {
                log('workflow-builder-output', 'Loading example workflow...');
                
                // Create example workflow
                const workflow = WorkflowEngine.createWorkflow('Code Review Pipeline');
                
                // Add nodes
                const input = workflow.addNode(WorkflowEngine.createInputNode()
                    .setPosition(100, 150)
                    .configure({ 
                        source: 'value',
                        value: 'Create a function to validate email addresses' 
                    }));
                
                // These two will run in parallel
                const generator = workflow.addNode(WorkflowEngine.createAgentNode(window.AgentFramework.AgentRoles.CODE_GENERATOR)
                    .setPosition(300, 50)
                    .configure({ 
                        taskType: 'generate',
                        prompt: 'Generate a JavaScript function based on this description',
                        language: 'javascript'
                    }));
                
                const tester = workflow.addNode(WorkflowEngine.createAgentNode(window.AgentFramework.AgentRoles.TESTING)
                    .setPosition(300, 250)
                    .configure({ 
                        taskType: 'generate',
                        prompt: 'Create test cases for a function that validates email addresses',
                        language: 'javascript'
                    }));
                
                // This waits for generator to complete
                const reviewer = workflow.addNode(WorkflowEngine.createAgentNode(window.AgentFramework.AgentRoles.CODE_REVIEWER)
                    .setPosition(500, 50)
                    .configure({ 
                        taskType: 'review',
                        language: 'javascript'
                    }));
                
                // Composer waits for all three
                const composer = workflow.addNode(WorkflowEngine.createComposerNode()
                    .setPosition(700, 150)
                    .configure({
                        composerFunction: `
// Combine all results into a final package
const result = {
    description: inputs.description || "Email validation function",
    implementation: inputs.generated?.code || inputs.generated,
    tests: inputs.tests?.code || inputs.tests,
    review: inputs.review
};

// Add metadata
result.metadata = {
    passed: inputs.review?.passed || false,
    score: inputs.review?.score || 0,
    timestamp: new Date().toISOString()
};

return result;`
                    }));
                
                const output = workflow.addNode(WorkflowEngine.createOutputNode()
                    .setPosition(900, 150)
                    .configure({ name: 'finalResult' }));
                
                // Connect nodes
                // Input goes to all three agents
                workflow.connect(input.id, 'output', generator.id, 'data');
                workflow.connect(input.id, 'output', tester.id, 'data');
                workflow.connect(input.id, 'output', composer.id, 'description');
                
                // Generator output goes to reviewer and composer
                workflow.connect(generator.id, 'output', reviewer.id, 'data');
                workflow.connect(generator.id, 'output', composer.id, 'generated');
                
                // Tester and reviewer outputs go to composer
                workflow.connect(tester.id, 'output', composer.id, 'tests');
                workflow.connect(reviewer.id, 'output', composer.id, 'review');
                
                // Composer to output
                workflow.connect(composer.id, 'output', output.id, 'value');
                
                log('workflow-builder-output', 'Example workflow created!', 'success');
                log('workflow-builder-output', `Workflow: ${workflow.name}`);
                log('workflow-builder-output', `Nodes: ${workflow.nodes.size}`);
                log('workflow-builder-output', `Connections: ${workflow.connections.length}`);
                log('workflow-builder-output', '');
                log('workflow-builder-output', 'This workflow demonstrates:');
                log('workflow-builder-output', '- Parallel execution (Generator and Tester run simultaneously)');
                log('workflow-builder-output', '- Sequential dependencies (Reviewer waits for Generator)');
                log('workflow-builder-output', '- Result composition (Composer combines all outputs)');
                log('workflow-builder-output', '');
                log('workflow-builder-output', 'Click "Open Workflow Builder" to visualize and run it!');
                
                // Save it for the builder
                window.exampleWorkflow = workflow;
                
            } catch (error) {
                log('workflow-builder-output', `Failed to load example: ${error.message}`, 'error');
            }
        }
        
        function showWorkflowTutorial() {
            log('workflow-builder-output', '\n=== Workflow Builder Tutorial ===', 'success');
            log('workflow-builder-output', '');
            log('workflow-builder-output', '1. CREATING WORKFLOWS:');
            log('workflow-builder-output', '   - Drag agents from the left palette onto the canvas');
            log('workflow-builder-output', '   - Use Input nodes to provide data to your workflow');
            log('workflow-builder-output', '   - Use Output nodes to capture results');
            log('workflow-builder-output', '   - Use Composer nodes to combine outputs from multiple agents');
            log('workflow-builder-output', '');
            log('workflow-builder-output', '2. CONNECTING NODES:');
            log('workflow-builder-output', '   - Click and drag from an output port (right side) to an input port (left side)');
            log('workflow-builder-output', '   - Agents can run in parallel if they have no dependencies');
            log('workflow-builder-output', '   - Data flows from left to right through connections');
            log('workflow-builder-output', '');
            log('workflow-builder-output', '3. CONFIGURING NODES:');
            log('workflow-builder-output', '   - Click a node to select it');
            log('workflow-builder-output', '   - Use the Properties panel on the right to configure:');
            log('workflow-builder-output', '     ‚Ä¢ Agent prompts and parameters');
            log('workflow-builder-output', '     ‚Ä¢ Composer functions (JavaScript)');
            log('workflow-builder-output', '     ‚Ä¢ Input values or context keys');
            log('workflow-builder-output', '');
            log('workflow-builder-output', '4. RUNNING WORKFLOWS:');
            log('workflow-builder-output', '   - Click the Run button to execute');
            log('workflow-builder-output', '   - Nodes will light up as they process');
            log('workflow-builder-output', '   - Results appear in Output nodes');
            log('workflow-builder-output', '');
            log('workflow-builder-output', '5. SAVING/LOADING:');
            log('workflow-builder-output', '   - Save workflows as JSON files');
            log('workflow-builder-output', '   - Load and share workflows with your team');
            log('workflow-builder-output', '');
            log('workflow-builder-output', 'Happy workflow building! üöÄ');
        }
        
        // Auto-initialize on load
        window.addEventListener('load', () => {
            setTimeout(initializeFramework, 1000);
        });
    </script>
</body>
</html>