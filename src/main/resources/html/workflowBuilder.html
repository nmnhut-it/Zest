<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Workflow Builder</title>
    
    <!-- Load Agent Framework dependencies from local resources -->
    <script src="jcef://resource/js/agentFramework.js"></script>
    <script src="jcef://resource/js/workflowEngine.js"></script>
    <script src="jcef://resource/js/workflowBuilder.js"></script>
    <script src="jcef://resource/js/agentUI.js"></script>
    <script src="jcef://resource/js/LLMProvider.js"></script>
    <script src="jcef://resource/js/fileAPI.js"></script>
    <script src="jcef://resource/js/researchAgentIntegrated.js"></script>
    <script src="jcef://resource/js/googleAgentIntegration.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #workflow-builder {
            width: 100%;
            height: 100%;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #4CAF50;
        }
        #error {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .loading-spinner {
            border: 3px solid #333;
            border-radius: 50%;
            border-top: 3px solid #4CAF50;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <h2>Loading Workflow Builder...</h2>
        <p>Initializing Agent Framework components...</p>
        <div id="loading-progress"></div>
    </div>
    
    <!-- Error display -->
    <div id="error"></div>
    
    <!-- Container for workflow builder -->
    <div id="workflow-builder" style="display: none;"></div>
    
    <!-- Initialize after all scripts are loaded -->
    <script>
        // Debug mode flag
        const JCEF_DEBUG = true; // Set to false to disable JS debug logs
        
        function debugLog(message, ...args) {
            if (JCEF_DEBUG) {
                console.log(`[JCEF DEBUG] ${message}`, ...args);
            }
        }
        
        function updateProgress(message) {
            const progressEl = document.getElementById('loading-progress');
            if (progressEl) {
                progressEl.textContent = message;
            }
            debugLog('Progress: %s', message);
        }
        
        function showError(message) {
            console.error(message);
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
            document.getElementById('loading').style.display = 'none';
            debugLog('Error shown: %s', message);
        }
        
        function checkDependencies() {
            debugLog('Checking dependencies...');
            updateProgress('Checking dependencies...');
            
            if (!window.AgentFramework) {
                showError('AgentFramework not loaded! Please ensure Agent Framework is initialized.');
                return false;
            }
            debugLog('✓ AgentFramework found');
            
            if (!window.AgentFramework.AgentRoles) {
                showError('AgentFramework.AgentRoles not found!');
                return false;
            }
            debugLog('✓ AgentFramework.AgentRoles found with %d roles', 
                Object.keys(window.AgentFramework.AgentRoles).length);
            
            if (!window.WorkflowEngine) {
                showError('WorkflowEngine not loaded! Please ensure Workflow Engine is initialized.');
                return false;
            }
            debugLog('✓ WorkflowEngine found');
            
            if (!window.WorkflowBuilder) {
                showError('WorkflowBuilder not loaded! Please ensure Workflow Builder script is loaded.');
                return false;
            }
            debugLog('✓ WorkflowBuilder found');
            
            debugLog('All dependencies loaded successfully');
            return true;
        }
        
        function initializeWorkflowBuilder() {
            debugLog('Initializing Workflow Builder...');
            updateProgress('Initializing Workflow Builder...');
            
            try {
                // Hide loading, show container
                document.getElementById('loading').style.display = 'none';
                document.getElementById('workflow-builder').style.display = 'block';
                
                // Initialize the workflow builder
                window.WorkflowBuilder.initialize('workflow-builder');
                debugLog('Workflow Builder initialized successfully');
                
                // Log available agent roles
                if (JCEF_DEBUG && window.AgentFramework && window.AgentFramework.AgentRoles) {
                    debugLog('Available Agent Roles:');
                    Object.entries(window.AgentFramework.AgentRoles).forEach(([key, role]) => {
                        debugLog('  - %s: %s', key, role.name);
                    });
                }
                
            } catch (error) {
                showError('Failed to initialize Workflow Builder: ' + error.message);
                console.error('Initialization error:', error);
                debugLog('Initialization failed with error:', error);
            }
        }
        
        // Wait for all dependencies to load
        let checkCount = 0;
        const maxChecks = 50; // 5 seconds maximum wait
        
        function waitForDependencies() {
            checkCount++;
            debugLog('Dependency check attempt %d/%d', checkCount, maxChecks);
            updateProgress(`Checking dependencies (${checkCount}/${maxChecks})...`);
            
            if (checkDependencies()) {
                initializeWorkflowBuilder();
            } else if (checkCount < maxChecks) {
                // Try again in 100ms
                setTimeout(waitForDependencies, 100);
            } else {
                showError('Timeout waiting for dependencies. Please check console for errors.');
                debugLog('Timeout reached after %d attempts', checkCount);
            }
        }
        
        // Start checking after a small delay to ensure scripts are loaded
        window.addEventListener('load', function() {
            debugLog('=== Workflow Builder Page Loaded ===');
            debugLog('Page URL: %s', window.location.href);
            debugLog('User Agent: %s', navigator.userAgent);
            console.log('Starting dependency check...');
            updateProgress('Page loaded, starting initialization...');
            setTimeout(waitForDependencies, 500);
        });
        
        // Also listen for a custom event in case scripts load later
        window.addEventListener('agentFrameworkReady', function() {
            debugLog('Agent Framework ready event received');
            if (checkDependencies() && !window.WorkflowBuilder.initialized) {
                initializeWorkflowBuilder();
            }
        });
        
        // Debug: Log all global objects
        if (JCEF_DEBUG) {
            setTimeout(() => {
                debugLog('=== Global Objects Check ===');
                const globalChecks = [
                    'intellijBridge',
                    'AgentFramework',
                    'WorkflowEngine',
                    'WorkflowBuilder',
                    'LLMProvider',
                    'ResearchAgent',
                    'FileAPI',
                    'AgentUI'
                ];
                
                globalChecks.forEach(objName => {
                    debugLog('%s: %s', objName, window[objName] ? '✓ Loaded' : '✗ Missing');
                });
                debugLog('=========================');
                
                // Test resource loading
                debugLog('=== Resource Loading Test ===');
                debugLog('Current URL: %s', window.location.href);
                debugLog('Protocol: %s', window.location.protocol);
                debugLog('Host: %s', window.location.host);
                
                // Test if we can access other resources
                const testResources = [
                    'jcef://resource/js/agentFramework.js',
                    'jcef://resource/html/agentDemo.html'
                ];
                
                testResources.forEach(url => {
                    fetch(url)
                        .then(response => {
                            debugLog('Resource %s: %s (%d)', url, response.ok ? 'OK' : 'FAILED', response.status);
                        })
                        .catch(error => {
                            debugLog('Resource %s: ERROR - %s', url, error.message);
                        });
                });
            }, 1000);
        }
    </script>
</body>
</html>
